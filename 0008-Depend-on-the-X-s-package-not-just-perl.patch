From 23e4377c20f9c652c6cfa844d464ff4f5c2620dc Mon Sep 17 00:00:00 2001
From: Josh ben Jore <jbenjore@whitepages.com>
Date: Sat, 9 May 2009 22:39:26 -0700
Subject: [PATCH] Depend on the $^X's package, not just "perl"

---
 lib/CPANPLUS/Dist/Deb/Constants.pm |   20 ++++++++++++++++++--
 1 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/lib/CPANPLUS/Dist/Deb/Constants.pm b/lib/CPANPLUS/Dist/Deb/Constants.pm
index 6f85e78..a66174f 100755
--- a/lib/CPANPLUS/Dist/Deb/Constants.pm
+++ b/lib/CPANPLUS/Dist/Deb/Constants.pm
@@ -4,6 +4,7 @@ use strict;
 use CPANPLUS::Error;
 use CPANPLUS::Internals::Constants;
 
+use Cwd                         qw[abs_path];
 use IPC::Cmd                    qw[can_run];
 use File::Spec;
 use Locale::Maketext::Simple    Class => 'CPANPLUS', Style => 'gettext';
@@ -260,8 +261,23 @@ use constant DEB_DEBHELPER      => 'debhelper (>= 4.0.2)';
 ### by perl, unless you explicilty undefined 'inc_version_list' as a config
 ### argument
 use constant DEB_THIS_PERL_DEPENDS
-                                => sub { use Config; 
-                                         "perl (>= $Config{version})" };
+                                => IS_SYSTEM_PERL
+                                   ? sub { use Config; 
+                                         "perl (>= $Config{version})" }
+                                   : do {
+                                       my $pid = open my($fh), '-|', 'dpkg', '-S', abs_path( $^X );
+                                       my ( $pkg ) = <$fh>;
+                                       close $fh;
+                                       waitpid $pid, 0;
+                                       if ( defined $pkg && $pkg =~ /^(\S+):/ ) {
+                                           $pkg = $1;
+                                           sub { "$pkg (>= $Config{version})" };
+                                       }
+                                       else {
+                                           warn "Can't find debian package for $^X";
+                                           sub { "" };
+                                       }
+                                     };
 use constant DEB_PERL_DEPENDS   => join ', ',
                                    ( IS_SYSTEM_PERL ? '${perl:Depends}' : () ),
                                    '${misc:Depends}',
-- 
1.6.0.4

